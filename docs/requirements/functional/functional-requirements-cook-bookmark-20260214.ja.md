# 機能要件書

**プロジェクト名**: Cook Bookmark
**作成日**: 2026-02-14
**バージョン**: 1.0

---

## FR-001〜004: 認証（実装済み）

**優先度**: Must Have
**カテゴリー**: 認証
**ステータス**: 実装済み

### 説明

Better Authを使用したGoogle OAuth 2.0によるユーザー認証。セキュアCookieによるセッション管理とルート保護ミドルウェア。

### 詳細要件

- **FR-001**: システムはGoogle OAuth 2.0でユーザーを認証するものとする
- **FR-002**: システムはセキュアCookieでユーザーセッションを維持するものとする
- **FR-003**: 未認証ユーザーが`/dashboard/*`にアクセスした場合、システムは`/login`にリダイレクトするものとする
- **FR-004**: ユーザーがサインアウトをクリックした場合、システムはセッションを破棄しランディングページにリダイレクトするものとする

### 受入基準（EARS形式）

#### AC-1: Googleログイン

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがGoogleログインボタンをクリックした場合、システムはGoogle OAuthにリダイレクトし、認証成功後にセッションを作成してダッシュボードにリダイレクトするものとする。
```

**テスト検証**:
- [x] 結合テスト: Google OAuthフローがエンドツーエンドで動作
- [x] 手動テスト: ログインがダッシュボードにリダイレクト

#### AC-2: セッション保護

**パターン**: イベント駆動（WHEN）

```
WHEN 未認証ユーザーが/dashboard/*に一致するページをリクエストした場合、システムはcallbackUrlパラメータ付きで/loginにリダイレクトするものとする。
```

**テスト検証**:
- [x] ミドルウェアテスト: 未認証アクセスがログインにリダイレクト

#### AC-3: サインアウト

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがサインアウトボタンをクリックした場合、システムはセッションCookieを無効化しランディングページにリダイレクトするものとする。
```

**テスト検証**:
- [x] 手動テスト: サインアウトがセッションをクリア

---

## FR-010〜015: レシピURL登録

**優先度**: Must Have
**カテゴリー**: レシピ登録

### 説明

ユーザーがレシピサイトのURLを送信すると、システムがページを取得し、Gemini AIに内容を送信してレシピデータを抽出・構造化して登録します。

### 詳細要件

1. **入力**
   - レシピURL（必須）

2. **処理**
   - URLからWebページの内容を取得・解析
   - 解析した内容をGemini APIに送信（抽出プロンプト付き）
   - AIから構造化されたレシピデータを受信
   - 抽出データをユーザー確認用に表示

3. **出力**
   - データベースに保存された構造化レシピレコード
   - フィールド: 料理名、材料、手順、調理時間、人数、カロリー、栄養情報、写真URL、元URL

### 受入基準（EARS形式）

#### AC-4: URL送信

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーが有効なURLを送信した場合、システムはページの内容を取得しAI抽出を開始するものとする。
```

**テスト検証**:
- [ ] 単体テスト: URLバリデーション
- [ ] 結合テスト: ページ内容の取得

#### AC-5: AI抽出

**パターン**: イベント駆動（WHEN）

```
WHEN ページ内容がGemini APIに送信された場合、システムは料理名、材料、手順、調理時間、人数、カロリー、栄養情報、写真URLを含む構造化レシピデータを受信・解析するものとする。
```

**テスト検証**:
- [ ] 単体テスト: Gemini APIレスポンスの解析
- [ ] 結合テスト: サンプルURLからのエンドツーエンド抽出

#### AC-6: フィールド欠損時

**パターン**: 異常系（IF...THEN）

```
IF レシピフィールドがソースページから抽出できない場合、THEN システムはそのフィールドを空欄にするかAI推定で補完し、登録プロセスをブロックしないものとする。
```

**テスト検証**:
- [ ] 単体テスト: 部分的な抽出結果のハンドリング

#### AC-7: ユーザー確認

**パターン**: イベント駆動（WHEN）

```
WHEN AI抽出が完了した場合、システムはデータベースに保存する前にユーザーのレビュー・確認用に抽出データを表示するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: プレビュー画面が抽出データを表示

#### AC-8: 元URL保存

**パターン**: イベント駆動（WHEN）

```
WHEN レシピが保存された場合、システムは元のURLを保存し、元ページへのリンクとして表示するものとする。
```

**テスト検証**:
- [ ] 単体テスト: 元URLが永続化される

---

## FR-020〜025: レシピ管理

**優先度**: Must Have（020〜022）、Should Have（023〜025）
**カテゴリー**: レシピ管理

### 説明

ユーザーはレシピの閲覧・編集・削除・カテゴリ分類・タグ付け・お気に入り登録ができます。

### 詳細要件

1. **入力**
   - 編集用レシピフィールド
   - カテゴリ選択
   - タグ入力
   - お気に入りトグル

2. **処理**
   - レシピレコードのCRUD操作
   - カテゴリ・タグの関連付け管理
   - お気に入りフラグの切り替え

3. **出力**
   - 更新されたレシピレコード
   - 更新されたカテゴリ・タグの関連付け

### 受入基準（EARS形式）

#### AC-9: レシピ一覧

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがダッシュボードに遷移した場合、システムは料理名、画像、評価、お気に入り状態を含むカード形式で全レシピを表示するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: ダッシュボードにレシピ一覧が表示

#### AC-10: レシピ編集

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがレシピを編集して保存した場合、システムはレシピレコードを更新し、更新された情報を表示するものとする。
```

**テスト検証**:
- [ ] 結合テスト: レシピ更新が永続化

#### AC-11: レシピ削除

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがレシピ削除を確認した場合、システムはレシピと関連タグをデータベースから削除するものとする。
```

**テスト検証**:
- [ ] 結合テスト: レシピと関連データが削除

#### AC-12: カテゴリ割り当て

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがレシピにカテゴリを割り当てた場合、システムはレシピのカテゴリ参照を更新するものとする。
```

**テスト検証**:
- [ ] 単体テスト: カテゴリ割り当てが永続化

#### AC-13: タグ管理

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがレシピのタグを追加または削除した場合、システムはrecipe_tagの関連付けを更新するものとする。
```

**テスト検証**:
- [ ] 単体テスト: タグの関連付けが作成・削除

#### AC-14: お気に入りトグル

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがレシピのお気に入りボタンをトグルした場合、システムはisFavoriteフラグを更新しUIに即座に反映するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: お気に入りトグルがUIを更新

---

## FR-030〜034: レシピ検索・フィルタリング

**優先度**: Must Have（030）、Should Have（031〜034）
**カテゴリー**: 検索・フィルタリング

### 説明

ユーザーはキーワードでレシピを検索し、カテゴリ・タグ・お気に入り・評価でフィルタリングできます。

### 受入基準（EARS形式）

#### AC-15: キーワード検索

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーが検索クエリを入力した場合、システムは料理名または材料にクエリ文字列を含むレシピをフィルタリングして表示するものとする（大文字小文字区別なし）。
```

**テスト検証**:
- [ ] 単体テスト: 検索が料理名と材料にマッチ

#### AC-16: カテゴリフィルター

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがカテゴリフィルターを選択した場合、システムは選択されたカテゴリに属するレシピのみを表示するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: カテゴリフィルターが結果を絞り込み

#### AC-17: タグフィルター

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがタグフィルターを選択した場合、システムは選択されたタグに関連付けられたレシピのみを表示するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: タグフィルターが結果を絞り込み

#### AC-18: お気に入りフィルター

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーがお気に入りフィルターを有効にした場合、システムはお気に入りに登録されたレシピのみを表示するものとする。
```

**テスト検証**:
- [ ] E2Eテスト: お気に入りレシピのみ表示

#### AC-19: 評価順ソート

**パターン**: イベント駆動（WHEN）

```
WHEN ユーザーが評価順ソートを選択した場合、システムは星評価の高い順にレシピを並べるものとする。
```

**テスト検証**:
- [ ] 単体テスト: ソート順が正しい

---

## FR-040〜042: 家族間共有

**優先度**: Must Have
**カテゴリー**: 共有

### 説明

すべての認証済みユーザーが単一のレシピコレクションを共有します。全員が同じレシピを閲覧できます。

### 受入基準（EARS形式）

#### AC-20: 共有コレクション

**パターン**: ユビキタス（SHALL）

```
システムはすべての認証済みユーザーに同じレシピコレクションを表示するものとする。
```

**テスト検証**:
- [ ] 結合テスト: 2人のユーザーが同じレシピリストを閲覧

#### AC-21: レシピ登録者表示

**パターン**: ユビキタス（SHALL）

```
システムは各レシピを登録したユーザーの名前を表示するものとする。
```

**テスト検証**:
- [ ] 単体テスト: CreatedByユーザー名が表示

---

## FR-050〜052: 星評価

**優先度**: Should Have
**カテゴリー**: 評価

### 説明

レシピ登録者が家族の反応に基づいて1〜5の星評価をつけます。

### 受入基準（EARS形式）

#### AC-22: レシピ評価

**パターン**: イベント駆動（WHEN）

```
WHEN レシピ登録者が星評価（1〜5）を設定した場合、システムは評価を保存しレシピに表示するものとする。
```

**テスト検証**:
- [ ] 結合テスト: 評価が永続化・表示

#### AC-23: 評価更新

**パターン**: イベント駆動（WHEN）

```
WHEN レシピ登録者が星評価を更新した場合、システムは新しい評価を保存し表示を更新するものとする。
```

**テスト検証**:
- [ ] 結合テスト: 評価更新が反映

---

## 依存関係

| 要件 | 依存先 |
|---|---|
| FR-010〜015（レシピ登録） | Gemini APIキー設定済み |
| FR-020〜025（レシピ管理） | FR-010（レシピ登録） |
| FR-030〜034（検索・フィルター） | FR-020（レシピ一覧） |
| FR-040〜042（家族共有） | FR-001（認証） |
| FR-050〜052（星評価） | FR-010（レシピ登録） |
